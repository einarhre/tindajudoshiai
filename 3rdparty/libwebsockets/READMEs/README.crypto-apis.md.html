<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>README.crypto-apis</title>
  <style type="text/css">
      code{white-space: pre-wrap;}
      span.smallcaps{font-variant: small-caps;}
      span.underline{text-decoration: underline;}
      div.column{display: inline-block; vertical-align: top; width: 50%;}
  </style>
</head>
<body>
<h1 id="lws-crypto-apis">Lws Crypto Apis</h1>
<h2 id="overview">Overview</h2>
<figure>
<img src="/doc-assets/lws-crypto-overview.svg" alt="lws crypto overview" /><figcaption>lws crypto overview</figcaption>
</figure>
<p>Lws provides a “generic” crypto layer on top of both OpenSSL and compatible tls library, and mbedtls. Using this layer, your code can work without any changes on both types of tls library crypto backends… it’s as simple as rebuilding lws with <code>-DLWS_WITH_MBEDTLS=0</code> or <code>=1</code> at cmake.</p>
<p>The generic layer can be used directly (as in, eg, the sshd plugin), or via another layer on top, which processes JOSE JSON objects using JWS (JSON Web Signatures), JWK (JSON Web Keys), and JWE (JSON Web Encryption).</p>
<p>The <code>JW</code> apis use the generic apis (<code>lws_genrsa_</code>, etc) to get the crypto tasks done, so anything they can do you can also get done using the generic apis. The main difference is that with the generic apis, you must instantiate the correct types and use type-specfic apis. With the <code>JW</code> apis, there is only one interface for all operations, with the details hidden in the api and controlled by the JSON objects.</p>
<p>Because of this, the <code>JW</code> apis are often preferred because they give you “crypto agility” cheaply… to change your crypto to another supported algorithm once it’s working, you literally just change your JSON defining the keys and JWE or JWS algorithm. (It’s up to you to define your policy for which combinations are acceptable by querying the parsed JW structs).</p>
<h2 id="crypto-supported-in-generic-layer">Crypto supported in generic layer</h2>
<h3 id="generic-hash">Generic Hash</h3>
<ul>
<li>SHA1</li>
<li>SHA256</li>
<li>SHA384</li>
<li>SHA512</li>
</ul>
<h3 id="generic-hmac">Generic HMAC</h3>
<ul>
<li>SHA256</li>
<li>SHA384</li>
<li>SHA512</li>
</ul>
<h3 id="generic-aes">Generic AES</h3>
<ul>
<li>CBC</li>
<li>CFB128</li>
<li>CFB8</li>
<li>CTR</li>
<li>ECB</li>
<li>OFB</li>
<li>XTS</li>
<li>GCM</li>
<li>KW (Key Wrap)</li>
</ul>
<h3 id="generic-rsa">Generic RSA</h3>
<ul>
<li>PKCS 1.5</li>
<li>OAEP / PSS</li>
</ul>
<h3 id="generic-ec">Generic EC</h3>
<ul>
<li>ECDH</li>
<li>ECDSA</li>
<li>P256 / P384 / P521 (sic) curves</li>
</ul>
<h2 id="using-the-generic-layer">Using the generic layer</h2>
<p>All the necessary includes are part of <code>libwebsockets.h</code>.</p>
<p>Enable <code>-DLWS_WITH_GENCRYPTO=1</code> at cmake.</p>
<table>
<colgroup>
<col style="width: 33%" />
<col style="width: 33%" />
<col style="width: 33%" />
</colgroup>
<thead>
<tr class="header">
<th>api</th>
<th>header</th>
<th>Functionality</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>genhash</td>
<td><a href="https://libwebsockets.org/git/libwebsockets/tree/include/libwebsockets/lws-genhash.h">./include/libwebsockets/lws-genhash.h</a></td>
<td>Provides SHA1 + SHA2 hashes and hmac</td>
</tr>
<tr class="even">
<td>genrsa</td>
<td><a href="https://libwebsockets.org/git/libwebsockets/tree/include/libwebsockets/lws-genrsa.h">./include/libwebsockets/lws-genrsa.h</a></td>
<td>Provides RSA encryption, decryption, signing, verification, key generation and creation</td>
</tr>
<tr class="odd">
<td>genaes</td>
<td><a href="https://libwebsockets.org/git/libwebsockets/tree/include/libwebsockets/lws-genaes.h">./include/libwebsockets/lws-genaes.h</a></td>
<td>Provides AES in all common variants for encryption and decryption</td>
</tr>
<tr class="even">
<td>genec</td>
<td><a href="https://libwebsockets.org/git/libwebsockets/tree/include/libwebsockets/lws-genec.h">./include/libwebsockets/lws-genec.h</a></td>
<td>Provides Elliptic Curve for encryption, decryption, signing, verification, key generation and creation</td>
</tr>
<tr class="odd">
<td>x509</td>
<td><a href="https://libwebsockets.org/git/libwebsockets/tree/include/libwebsockets/lws-x509.h">./include/libwebsockets/lws-x509.h</a></td>
<td>Apis for X.509 Certificate loading, parsing, and stack verification, plus JWK key extraction from PEM X.509 certificate / private key</td>
</tr>
</tbody>
</table>
<p>Unit tests for these apis, which serve as usage examples, can be found in <a href="https://libwebsockets.org/git/libwebsockets/tree/minimal-examples/api-tests/api-test-gencrypto">./minimal-examples/api-tests/api-test-gencrypto</a></p>
<h3 id="keys-in-the-generic-layer">Keys in the generic layer</h3>
<p>The necessary types and defines are brought in by <code>libwebsockets.h</code>.</p>
<p>Keys are represented only by an array of <code>struct lws_jwk_elements</code>… the length of the array is defined by the cipher… it’s one of</p>
<table>
<thead>
<tr class="header">
<th>key elements count</th>
<th>definition</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>LWS_COUNT_OCT_KEY_ELEMENTS</code></td>
<td>1</td>
</tr>
<tr class="even">
<td><code>LWS_COUNT_RSA_KEY_ELEMENTS</code></td>
<td>8</td>
</tr>
<tr class="odd">
<td><code>LWS_COUNT_EC_KEY_ELEMENTS</code></td>
<td>4</td>
</tr>
<tr class="even">
<td><code>LWS_COUNT_AES_KEY_ELEMENTS</code></td>
<td>1</td>
</tr>
</tbody>
</table>
<p><code>struct lws_jwk_elements</code> is a simple pointer / length combination used to store arbitrary octets that make up the key element’s binary representation.</p>
<h2 id="using-the-jose-layer">Using the JOSE layer</h2>
<p>The JOSE (JWK / JWS / JWE) stuff is a crypto-agile JSON-based layer that uses the gencrypto support underneath.</p>
<p>“Crypto Agility” means the JSON structs include information about the algorithms and ciphers used in that particular object, making it easy to upgrade system crypto strength or cycle keys over time while supporting a transitional period where the old and new keys or algorithms + ciphers are also valid.</p>
<p>Uniquely lws generic support means the JOSE stuff also has “tls library agility”, code written to the lws generic or JOSE apis is completely unchanged even if the underlying tls library changes between OpenSSL and mbedtls, meaning sharing code between server and client sides is painless.</p>
<p>All the necessary includes are part of <code>libwebsockets.h</code>.</p>
<p>Enable <code>-DLWS_WITH_JOSE=1</code> at CMake.</p>
<table>
<colgroup>
<col style="width: 33%" />
<col style="width: 33%" />
<col style="width: 33%" />
</colgroup>
<thead>
<tr class="header">
<th>api</th>
<th>header</th>
<th>Functionality</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>JOSE</td>
<td><a href="https://libwebsockets.org/git/libwebsockets/tree/include/libwebsockets/lws-jose.h">./include/libwebsockets/lws-jose.h</a></td>
<td>Provides crypto agility for JWS / JWE</td>
</tr>
<tr class="even">
<td>JWE</td>
<td><a href="https://libwebsockets.org/git/libwebsockets/tree/include/libwebsockets/lws-jwe.h">./include/libwebsockets/lws-jwe.h</a></td>
<td>Provides Encryption and Decryption services for RFC7516 JWE JSON</td>
</tr>
<tr class="odd">
<td>JWS</td>
<td><a href="https://libwebsockets.org/git/libwebsockets/tree/include/libwebsockets/lws-jws.h">./include/libwebsockets/lws-jws.h</a></td>
<td>Provides signature and verifcation services for RFC7515 JWS JSON</td>
</tr>
<tr class="even">
<td>JWK</td>
<td><a href="https://libwebsockets.org/git/libwebsockets/tree/include/libwebsockets/lws-jwk.h">./include/libwebsockets/lws-jwk.h</a></td>
<td>Provides signature and verifcation services for RFC7517 JWK JSON, both “keys” arrays and singletons</td>
</tr>
</tbody>
</table>
<p>Minimal examples are provided in the form of commandline tools for JWK / JWS / JWE / x509 handling:</p>
<ul>
<li><a href="https://libwebsockets.org/git/libwebsockets/tree/minimal-examples/crypto/minimal-crypto-jwk">JWK minimal example</a></li>
<li><a href="https://libwebsockets.org/git/libwebsockets/tree/minimal-examples/crypto/minimal-crypto-jws">JWS minimal example</a></li>
<li><a href="https://libwebsockets.org/git/libwebsockets/tree/minimal-examples/crypto/minimal-crypto-jwe">JWE minimal example</a></li>
<li><a href="https://libwebsockets.org/git/libwebsockets/tree/minimal-examples/crypto/minimal-crypto-x509">X509 minimal example</a></li>
</ul>
<p>Unit tests for these apis, which serve as usage examples, can be found in <a href="https://libwebsockets.org/git/libwebsockets/tree/minimal-examples/api-tests/api-test-jose">./minimal-examples/api-tests/api-test-jose</a></p>
<h2 id="crypto-supported-in-the-jose-layer">Crypto supported in the JOSE layer</h2>
<p>The JOSE RFCs define specific short names for different algorithms</p>
<h3 id="jws">JWS</h3>
<table>
<thead>
<tr class="header">
<th>JSOE name</th>
<th>Hash</th>
<th>Signature</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>RS256, RS384, RS512</td>
<td>SHA256/384/512</td>
<td>RSA</td>
</tr>
<tr class="even">
<td>ES256, ES384, ES521</td>
<td>SHA256/384/512</td>
<td>EC</td>
</tr>
</tbody>
</table>
<h3 id="jwe">JWE</h3>
<table>
<thead>
<tr class="header">
<th>Key Encryption</th>
<th>Payload authentication + crypt</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>RSAES-PKCS1-v1.5</code> 2048b &amp; 4096b</td>
<td><code>AES_128_CBC_HMAC_SHA_256</code></td>
</tr>
<tr class="even">
<td><code>RSAES-PKCS1-v1.5</code> 2048b</td>
<td><code>AES_192_CBC_HMAC_SHA_384</code></td>
</tr>
<tr class="odd">
<td><code>RSAES-PKCS1-v1.5</code> 2048b</td>
<td><code>AES_256_CBC_HMAC_SHA_512</code></td>
</tr>
<tr class="even">
<td><code>RSAES-OAEP</code></td>
<td><code>AES_256_GCM</code></td>
</tr>
<tr class="odd">
<td><code>AES128KW</code>, <code>AES192KW</code>, <code>AES256KW</code></td>
<td><code>AES_128_CBC_HMAC_SHA_256</code></td>
</tr>
<tr class="even">
<td><code>AES128KW</code>, <code>AES192KW</code>, <code>AES256KW</code></td>
<td><code>AES_192_CBC_HMAC_SHA_384</code></td>
</tr>
<tr class="odd">
<td><code>AES128KW</code>, <code>AES192KW</code>, <code>AES256KW</code></td>
<td><code>AES_256_CBC_HMAC_SHA_512</code></td>
</tr>
<tr class="even">
<td><code>ECDH-ES</code> (P-256/384/521 key)</td>
<td><code>AES_128/192/256_GCM</code></td>
</tr>
<tr class="odd">
<td><code>ECDH-ES+A128/192/256KW</code> (P-256/384/521 key)</td>
<td><code>AES_128/192/256_GCM</code></td>
</tr>
</tbody>
</table>
<h3 id="keys-in-the-jose-layer">Keys in the JOSE layer</h3>
<p>Keys in the JOSE layer use a <code>struct lws_jwk</code>, this contains two arrays of <code>struct lws_jwk_elements</code> sized for the worst case (currently RSA). One array contains the key elements as described for the generic case, and the other contains various nonencrypted key metadata taken from JWK JSON.</p>
<table>
<colgroup>
<col style="width: 50%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr class="header">
<th>metadata index</th>
<th>function</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>JWK_META_KTY</code></td>
<td>Key type, eg, “EC”</td>
</tr>
<tr class="even">
<td><code>JWK_META_KID</code></td>
<td>Arbitrary ID string</td>
</tr>
<tr class="odd">
<td><code>JWK_META_USE</code></td>
<td>What the public key may be used to validate, “enc” or “sig”</td>
</tr>
<tr class="even">
<td><code>JWK_META_KEY_OPS</code></td>
<td>Which operations the key is authorized for, eg, “encrypt”</td>
</tr>
<tr class="odd">
<td><code>JWK_META_X5C</code></td>
<td>Optional X.509 cert version of the key</td>
</tr>
<tr class="even">
<td><code>JWK_META_ALG</code></td>
<td>Optional overall crypto algorithm the key is intended for use with</td>
</tr>
</tbody>
</table>
<p><code>lws_jwk_destroy()</code> should be called when the jwk is going out of scope… this takes care to zero down any key element data in the jwk.</p>
</body>
</html>
